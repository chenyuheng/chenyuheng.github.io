# 挖掘质数们：网络设备里广泛分布的弱密钥探测

*Nadia Heninger, Zakir Durumeric, Eric Wustrow, and J. Alex Halderman. 2012. Mining your Ps and Qs: detection of widespread weak keys in network devices. In* *Proceedings of the 21st USENIX conference on Security symposium* *(**Security'12**). USENIX Association, USA, 35.*

这篇文章的阅读笔记。

## 介绍

在现代密码学中，随机数生成是很重要的。RSA 相关的协议中，存在很多由于随机数生成不够随机导致的安全隐患。本文先调查了一下网络上的两个重要的密码学相关协议（TLS 和 SSH）的密钥，分析其中的随机性，然后尝试破解。竟然有绝对数量不小的密钥都被破解了（比例大概千分之几）。然后文章分析为什么会这样，及其深层的原理。然后文章给出了建议的预防应对措施，还给了一个检测工具。

## 背景知识

### RSA

RSA 公钥包括指数 e 和模数 N。e 在不同的公钥中是可以共用的，但模数不行，否则有安全问题。模数 N 是随机选择的两个大质数 p 和 q 的乘积（p 和 q 是私密的）。私钥 d 的计算公式为：$d=e^{-1} \ mod\ \Phi(N) =e^{-1}\ mod\ (p-1)(q-1)$

如果 N 被分解了，那么 RSA 的安全性就失效了。

在只知道 N 的情况下分解 N，目前已知的最大 N 位数是 768 位，对于 1024 位的 RSA 模数，目前没有方法分解。

但如果攻击者找到了两个公钥的模数 $N_1$ 和 $N_2$ 共享同一个质数但不共享另外一个质数，通过很快的辗转相除法求他们的最大公因数，就可以很容易地分解模数，从而很容易被破解

### DSA

DSA 是数字签名（Digital Signature Algorithm），跟 RSA 不一样，是利用离散对数的原理设计的算法。因为我没学过或者忘记了暂时就不仔细看了，主要研究 RSA 的问题。

### 攻击场景

TLS 下，服务器在传输层协议握手时会发送其公钥，公钥可用于握手时提供签名（迪菲-赫尔曼密钥交换）或在传输数据时加密会话密钥（session key），如果 RSA 被破解了，那么攻击者就可以进行中间人攻击，监听或者修改加密通信，但如果使用迪菲-赫尔曼密钥交换，则无法进行被动攻击。

SSH 下，情况类似。

## 调查方法

### 整个互联网的扫描

扫描整个互联网的支持 TCP 端口 443 或者 22 的 IPv4 地址。先用 nmap 扫描得到 443 或者 22 端口开放的 IP 地址，然后从这些 IP 地址中取回证书和签名存在关系数据库里。

公钥和证书各收集到了五百多万个。

### 识别缺陷设备模式

TLS 证书的 X.509 标准里面由 subject 和 issuer 字段，这个很好用。也有没有这两个字段的证书，可以尝试其他方法，比如 nmap、网站内容查询之类的。

### 快速计算所有公钥对的最大公因数

略。

不要求快速的话暴力算法就行，很简单。

## 存在的缺陷

有重复的密钥、可分解的密钥和 DSA 弱点三大类缺陷。其中重复的密钥包括使用默认密钥、使用低熵生成两大类问题。

## 实验调查

分为调查随机数生成器和调查可分解的 RSA 密钥两部分。另有对 DSA 的调查。

随机数生成器有若干熵的来源，在某些特定的系统条件下，可能会出现不够随机的问题。

但随机数生成器的问题不应该影响 RSA 生成，因为根据之前的调查，有很多不同设备生成的密钥共享质数。

经过观察猜想和测试，结论是 OpenSSH 第一次生成素数时可能会存在同样的系统条件，导致生成了相同的素数，而第二次则发散了。